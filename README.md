# Hats-finance `"Challenge #1 CTF"` POC

## :memo: Getting Started

This repo contains a POC of Challenge #1 CTF of Hats Finance [`Original Repo`](https://github.com/hats-finance/games).

### :fountain_pen: Prerequisites

You will need to install foundry to run the exploit. Link for installtion [`Foundry`](https://github.com/foundry-rs/foundry).

### :sunglasses: A Description & Goal of the CTF 
- A super mon is minted to the deployer of the [`Game.sol`](./src/Game.sol)
- Three mons are minted to a user who plays by calling the `join()` function.
- The mons are generated by randomizing the powers using `_minMon()`.
- Funtions such as `SwapForNewMon()`, `Swap(id)` are provided to get a better mon either by burning the current mon or by swapping it to someone who has put their up  their mon for sale.
- User should play the game in such a way, that `game.flagHolder` should return the user's address, beating the superMon.

### :cowboy_hat_face: The solution 
There are a few pre-requisite that one needs to know before go about hacking. The knowledge regarding ERC721 & IERC721Receiver is essential in this case. In order to win our address needs to be the `flagHolder` which is set in `fight()` method in [Game.sol](./src/Game.sol) after comparing the balances of both addresses `attacker` & `flagHolder`. There is no way to beat the superMons by strength. So what do we do ? We borrow more mons to do our bidding! i.e `attacker's mons` > `flagHolder mons`.
- We start by deploying 3 contracts, an attacker [`CTF.sol`](./src/CTF.sol) & 2 [`helper.sol`](./src/Helper.sol) contracts.
- Helper contracts have a function `swap(id)` for swapping their mons with the ones that are up for sale.
- [`CTF.sol`](./src/CTF.sol) contracts calls has a function called `attack()` that invokes `helper contract's` swap function, which in turn sends the mon to `msg.sender` which in this case is the attacker address. Why ? If we look closely, the swap function sends the the caller's mon to receiver & then the sends the receiver's mon to the caller. 
- When the attack receives the NFT, `IERC721TokenReceiver` kicks in. At this point the attacker has `4` mons. We then call swap again in the fallback & swap attacker's second mon when the second NFT is received we again hit the fallback & we call the swap again. At this moment, we have `6` mons. We just need `1` more to win.
- We do the same for our last mon & swap it to us from `second helper contract`. We now have `7` mons in `attacker` contract.
- We can call `fight()` function from the callback. Since we have `7` mons & the `flagHolder` has `3` out of which our `3` mons will be burned as we can't out strength the super mons but still have `4` left in our pocket. Setting us as winners!


### How to exploit, Anon ?

1. Clone the repo
   ```sh
   git clone https://github.com/abdulsamijay/hats-challanege-1
   ```
2. Build the example to install all packages
   ```sh
   forge build
   ```
3. Run the exploit
   ```sh
   forge test -vv
   ```

<p align="right">(<a href="#top">back to top</a>)</p>
